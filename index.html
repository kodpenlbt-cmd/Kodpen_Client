<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KODPEN COFFEE - Official Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
        :root { --sb-green: #00704A; --sb-dark: #1E3932; --sb-light: #D4E9E2; }
        body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; }
        .bg-starbucks { background-color: var(--sb-green); }
        .text-starbucks { color: var(--sb-green); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .menu-card { transition: all 0.3s ease; }
        .menu-card:active { scale: 0.98; }
        .sold-out { filter: grayscale(1); opacity: 0.6; pointer-events: none; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .blink-notif { animation: pulse-red 1s infinite; }
        #receipt-area { width: 58mm; padding: 10px; background: white; color: black; font-family: monospace; font-size: 11px; line-height: 1.2; }
        .receipt-hidden { position: absolute; left: -9999px; }
    </style>
</head>
<body class="pb-32">
    <nav class="bg-starbucks text-white p-4 sticky top-0 z-50 shadow-xl flex justify-between items-center">
        <div class="font-black tracking-tighter text-xl italic">KODPEN COFFEE</div>
        <button id="muteBtn" onclick="toggleMute()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
            <i id="muteIcon" class="fas fa-volume-up"></i>
        </button>
    </nav>

    <div class="container mx-auto px-4 py-6 max-w-md">
        <div class="text-center mb-8">
            <img src="logo_kodpen.png" class="mx-auto w-24 mb-4 drop-shadow-lg" onerror="this.src='https://via.placeholder.com/100?text=KODPEN'">
            <h2 class="text-2xl font-black text-starbucks italic uppercase tracking-tighter">"So Ba Kopi Bro?"</h2>
        </div>

        <div class="mb-8 rounded-3xl overflow-hidden shadow-2xl border-4 border-white">
            <img src="ThisOurMenu.jpg" class="w-full">
        </div>

        <div class="glass-card p-6 rounded-3xl shadow-lg mb-6 border-b-4 border-starbucks">
            <label class="block font-black text-xs uppercase mb-3 text-gray-400 tracking-widest">Silahkan Pilih Meja:</label>
            <select id="nomorMeja" class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl font-bold outline-none focus:border-starbucks transition">
                <option value="">-- Pilih Nomor Meja --</option>
            </select>
        </div>

        <div id="menuContainer" class="space-y-8 mb-8">
            <div class="flex justify-center py-10"><i class="fas fa-circle-notch fa-spin fa-2xl text-starbucks"></i></div>
        </div>

        <div id="ringkasanContainer" class="hidden glass-card p-6 rounded-3xl shadow-lg mb-6 border-l-8 border-starbucks transition-all">
            <label class="block font-black text-[10px] uppercase mb-4 text-starbucks tracking-widest">Pesanan Anda:</label>
            <div id="ringkasanList" class="space-y-2 mb-4"></div>
        </div>

        <div class="glass-card p-6 rounded-3xl shadow-lg mb-6">
            <label class="block font-black text-xs uppercase mb-4 text-gray-400 tracking-widest text-center">Metode Pembayaran:</label>
            <div class="space-y-3">
                <label class="flex items-center p-4 border-2 border-gray-100 rounded-2xl cursor-pointer has-[:checked]:border-starbucks has-[:checked]:bg-green-50 transition">
                    <input type="radio" name="payment" value="Tunai" onchange="valBtn()" class="w-5 h-5 accent-starbucks" checked>
                    <div class="ml-4"><p class="font-black text-sm uppercase">Tunai</p><p class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">Bayar di Kasir</p></div>
                </label>
                <label class="flex items-center p-4 border-2 border-gray-100 rounded-2xl cursor-pointer has-[:checked]:border-starbucks has-[:checked]:bg-green-50 transition">
                    <input type="radio" name="payment" value="QRIS" onchange="valBtn()" class="w-5 h-5 accent-starbucks">
                    <div class="ml-4"><p class="font-black text-sm uppercase">QRIS / E-Wallet</p><p class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">Scan Barcode Otomatis</p></div>
                </label>
                <label class="flex items-center p-4 border-2 border-blue-100 rounded-2xl cursor-pointer has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 transition">
                    <input type="radio" name="payment" value="Transfer BNI" onchange="valBtn()" class="w-5 h-5 accent-blue-600">
                    <div class="ml-4"><p class="font-black text-blue-800 text-sm uppercase leading-none">BANK BNI</p><p class="text-blue-600 font-black text-lg tracking-widest">0388924011</p><p class="text-[9px] text-blue-900 font-bold uppercase">A.n FAZRIN HARUN</p></div>
                </label>
            </div>

            <div id="uploadArea" class="hidden mt-6 p-6 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-300 text-center">
                <div id="qrisSection" class="hidden mb-4">
                    <img src="Barcode.png" class="w-48 mx-auto rounded-2xl shadow-xl border-4 border-white mb-3">
                    <p class="text-[9px] font-black text-gray-400 uppercase italic">Scan atau Simpan Barcode di atas</p>
                </div>
                <p class="text-xs font-black text-red-600 mb-4 uppercase">Wajib Upload Bukti Transfer!</p>
                <input type="file" id="buktiFile" accept="image/*" onchange="valBtn()" class="text-xs block w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-black file:bg-starbucks file:text-white hover:file:bg-green-700">
            </div>
        </div>

        <div id="statusContainer" class="hidden glass-card p-6 rounded-3xl shadow-2xl mb-6 border-t-4 border-starbucks text-center animate-bounce">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-100 p-3 rounded-2xl"><p class="text-[9px] font-black text-gray-400 uppercase">No. Antrean</p><p id="txtNoAntrean" class="text-3xl font-black text-black">#0</p></div>
                <div class="bg-orange-50 p-3 rounded-2xl"><p class="text-[9px] font-black text-orange-600 uppercase">Sisa Antrean</p><p id="txtSisaAntrean" class="text-3xl font-black text-orange-700">0</p></div>
            </div>
            <div id="msgStatus" class="p-4 rounded-2xl font-black text-xs uppercase blink-notif"></div>
            <button id="btnStopJemput" onclick="stopJemputAlarm()" class="hidden w-full mt-4 bg-blue-600 text-white py-3 rounded-2xl font-black text-xs uppercase shadow-lg">MATIKAN ALARM / JEMPUT</button>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-xl border-t border-gray-100 shadow-[0_-10px_30px_rgba(0,0,0,0.1)] z-40">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-end mb-4 px-2">
                <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Total Bayar:</span>
                <span id="totalHarga" class="text-3xl font-black text-starbucks leading-none">Rp 0</span>
            </div>
            <button id="btnPesan" onclick="kirimPesanan()" class="w-full bg-starbucks text-white font-black py-5 rounded-3xl shadow-2xl active:scale-95 transition-all uppercase tracking-widest text-sm disabled:opacity-40 disabled:grayscale">PESAN SEKARANG</button>
            <button id="btnMyBill" onclick="unduhStruk()" class="hidden w-full bg-blue-600 text-white font-black py-5 rounded-3xl shadow-xl uppercase text-xs">DOWNLOAD NOTA (MY BILL)</button>
        </div>
    </div>

    <div class="receipt-hidden"><div id="receipt-area"></div></div>

    <script>
        // GANTI DENGAN URL DEPLOYMENT APPS SCRIPT ANDA
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyc1NTwGlo0QhZMOYQmk_yrVo06584mQFUYRqgj0FjIHbVuW7jOCTkndCoaSrhqp0N-kA/exec';
        
        let keranjang = {}; 
        let pollInterval; 
        let isMuted = false;
        let lastOrder = null;
        const soundJemput = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 

        document.addEventListener('DOMContentLoaded', () => {
            initMeja();
            loadMenu();
            checkSavedOrder();
        });

        function initMeja() {
            const sel = document.getElementById('nomorMeja');
            for(let i=1; i<=20; i++) sel.innerHTML += `<option value="${i}">Meja ${i}</option>`;
            const urlMeja = new URLSearchParams(window.location.search).get('meja');
            if(urlMeja) sel.value = urlMeja;
        }

        async function loadMenu() {
            try {
                const res = await fetch(`${scriptURL}?getMenu=true`);
                const menus = await res.json();
                renderMenu(menus);
            } catch (e) { console.error("Gagal muat menu", e); }
        }

        function renderMenu(menus) {
            const container = document.getElementById('menuContainer');
            container.innerHTML = "";
            const categories = [...new Set(menus.map(m => m.cat))];

            categories.forEach(cat => {
                let catHtml = `<div class="mb-6"><h3 class="text-lg font-black uppercase tracking-tighter border-l-4 border-starbucks pl-3 mb-4 text-gray-800">${cat}</h3><div class="grid grid-cols-1 gap-4">`;
                menus.filter(m => m.cat === cat).forEach(item => {
                    const isClose = item.s === "Close";
                    const itemID = item.n.replace(/\s+/g, '');
                    catHtml += `
                        <div class="menu-card glass-card p-4 rounded-3xl flex justify-between items-center shadow-sm ${isClose ? 'sold-out' : ''}">
                            <div class="flex-1">
                                <p class="font-black text-gray-800 text-sm uppercase leading-tight">${item.n}</p>
                                <p class="text-xs font-bold text-starbucks mt-1">Rp ${Number(item.h).toLocaleString()}</p>
                                ${isClose ? '<span class="text-[9px] font-black bg-red-600 text-white px-2 py-0.5 rounded-full uppercase">Sold Out</span>' : ''}
                            </div>
                            <div class="flex items-center gap-4">
                                <button onclick="qty('${item.n}',${item.h},-1)" class="w-10 h-10 rounded-2xl bg-gray-100 flex items-center justify-center font-black text-lg hover:bg-gray-200">-</button>
                                <span id="q-${itemID}" class="font-black text-lg w-4 text-center">0</span>
                                <button onclick="qty('${item.n}',${item.h},1)" class="w-10 h-10 rounded-2xl bg-starbucks text-white flex items-center justify-center font-black text-lg shadow-lg hover:scale-110 transition">+</button>
                            </div>
                        </div>`;
                });
                container.innerHTML += catHtml + `</div></div>`;
            });
        }

        function qty(n, h, c) {
            if(!keranjang[n]) keranjang[n] = {q:0, h:h};
            keranjang[n].q += c;
            if(keranjang[n].q < 0) keranjang[n].q = 0;
            document.getElementById('q-' + n.replace(/\s+/g,'')).innerText = keranjang[n].q;
            updateRingkasan();
        }

        function updateRingkasan() {
            const cont = document.getElementById('ringkasanContainer');
            const list = document.getElementById('ringkasanList');
            let total = 0;
            list.innerHTML = "";
            
            Object.keys(keranjang).forEach(k => {
                if(keranjang[k].q > 0) {
                    const sub = keranjang[k].q * keranjang[k].h;
                    total += sub;
                    list.innerHTML += `<div class="flex justify-between items-center text-xs font-bold text-gray-700"><span>${k} (x${keranjang[k].q})</span><span>Rp ${sub.toLocaleString()}</span></div>`;
                }
            });

            cont.classList.toggle('hidden', total === 0);
            document.getElementById('totalHarga').innerText = "Rp " + total.toLocaleString('id-ID');
            valBtn();
        }

        function valBtn() {
            const pay = document.querySelector('input[name="payment"]:checked').value;
            const btn = document.getElementById('btnPesan');
            const file = document.getElementById('buktiFile');
            
            document.getElementById('uploadArea').classList.toggle('hidden', pay === 'Tunai');
            document.getElementById('qrisSection').classList.toggle('hidden', pay !== 'QRIS');

            if(pay === 'Tunai') btn.disabled = false;
            else btn.disabled = (file.files.length === 0);
        }

        async function kirimPesanan() {
            const meja = document.getElementById('nomorMeja').value;
            if(!meja) return alert("Pilih Nomor Meja!");
            
            let detail = "";
            Object.keys(keranjang).forEach(k => { if(keranjang[k].q > 0) detail += `${k} (x${keranjang[k].q}), `; });
            if(!detail) return alert("Pilih Menu Dulu!");

            const btn = document.getElementById('btnPesan');
            btn.innerText = "MENGIRIM..."; btn.disabled = true;

            const orderId = "ORD-" + new Date().getTime();
            const pay = document.querySelector('input[name="payment"]:checked').value;
            
            let fileB64 = "";
            const fileInput = document.getElementById('buktiFile');
            if(fileInput.files.length > 0) {
                fileB64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }

            lastOrder = { 
                orderId, meja, 
                pesanan: detail.slice(0,-2), 
                pembayaran: pay, 
                total: document.getElementById('totalHarga').innerText,
                date: new Date().toLocaleString() 
            };

            fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify({...lastOrder, fileBase64: fileB64, fileName: fileInput.files[0]?.name})
            })
            .then(res => res.json())
            .then(() => {
                localStorage.setItem('kodpen_id', orderId);
                localStorage.setItem('kodpen_data', JSON.stringify(lastOrder));
                alert("PESANAN BERHASIL TERKIRIM!");
                window.location.reload();
            })
            .catch(() => alert("Gagal mengirim. Periksa koneksi!"));
        }

        function checkSavedOrder() {
            const savedID = localStorage.getItem('kodpen_id');
            const savedData = localStorage.getItem('kodpen_data');
            if(savedID && savedData) {
                lastOrder = JSON.parse(savedData);
                document.getElementById('btnPesan').classList.add('hidden');
                document.getElementById('btnMyBill').classList.remove('hidden');
                document.getElementById('statusContainer').classList.remove('hidden');
                startPolling(savedID);
            }
        }

        function startPolling(id) {
            pollInterval = setInterval(() => {
                fetch(`${scriptURL}?orderId=${id}`)
                .then(r => r.json())
                .then(data => {
                    if(data.status === "NotFound") { localStorage.clear(); location.reload(); }
                    
                    document.getElementById('txtNoAntrean').innerText = "#" + data.antrean;
                    document.getElementById('txtSisaAntrean').innerText = data.sisa;
                    
                    const msg = document.getElementById('msgStatus');
                    if(data.status === "Antri") {
                        msg.innerText = lastOrder.pembayaran === "Tunai" ? "Segera Bayar di Kasir!" : "Menunggu Barista...";
                        msg.className = "p-4 rounded-2xl font-black text-xs bg-red-100 text-red-600 blink-notif";
                    } else if(data.status === "Proses") {
                        msg.innerText = "Pesanan Sedang Dibuat â˜•";
                        msg.className = "p-4 rounded-2xl font-black text-xs bg-green-600 text-white";
                    } else if(data.status === "Jemput") {
                        msg.innerText = "PESANAN SIAP DI AMBIL! ðŸ””";
                        msg.className = "p-4 rounded-2xl font-black text-xs bg-blue-600 text-white";
                        document.getElementById('btnStopJemput').classList.remove('hidden');
                        if(!isMuted) soundJemput.play().catch(()=>{});
                    } else if(data.status === "Selesai") {
                        alert("Terima Kasih! Pesanan Selesai.");
                        localStorage.clear(); location.reload();
                    } else if(data.status === "Batal") {
                        alert("Maaf, Pesanan Anda Dibatalkan.");
                        localStorage.clear(); location.reload();
                    }
                });
            }, 4000);
        }

        function unduhStruk() {
            const area = document.getElementById('receipt-area');
            area.innerHTML = `
                <div style="text-align:center">
                    <strong style="font-size:14px">KODPEN COFFEE</strong><br>
                    MEJA ${lastOrder.meja}<br>
                    ${lastOrder.date}<br>
                    ----------------------------<br>
                    <div style="text-align:left">${lastOrder.pesanan.split(', ').join('<br>')}</div>
                    ----------------------------<br>
                    <strong>TOTAL: ${lastOrder.total}</strong><br>
                    BAYAR: ${lastOrder.pembayaran}<br>
                    ----------------------------<br>
                    TERIMA KASIH!
                </div>`;
            html2canvas(area, {scale:3}).then(canvas => {
                const link = document.createElement('a');
                link.download = `Nota_KODPEN_Meja${lastOrder.meja}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteIcon').className = isMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
        }

        function stopJemputAlarm() {
            soundJemput.pause();
            document.getElementById('btnStopJemput').innerText = "MENUNGGU BARISTA...";
        }
    </script>
</body>
</html>
