<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KODPEN COFFEE - Official Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --sb-green: #00704A; }
        .bg-starbucks { background-color: var(--sb-green); }
        .text-starbucks { color: var(--sb-green); }
        .menu-item { border-bottom: 1px solid #eee; padding: 12px 0; }
        @keyframes blinker { 50% { opacity: 0; } }
        .blink-notif { animation: blinker 0.8s linear infinite; }
        #receipt-area { width: 58mm; padding: 10px; background: white; color: black; font-family: monospace; font-size: 11px; line-height: 1.2; }
        .receipt-hidden { position: absolute; left: -9999px; top: 0; }
        
        #btnPesan:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(1);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <nav class="bg-starbucks text-white p-4 sticky top-0 z-50 shadow-lg text-center font-bold tracking-widest uppercase">KODPEN COFFEE</nav>

    <div class="container mx-auto px-4 py-6 max-w-md">
        <div id="notifPermissionBox" class="hidden mb-4 p-4 bg-blue-700 text-white rounded-2xl shadow-lg flex flex-col gap-2">
            <p class="text-xs font-bold uppercase text-center">Aktifkan Notifikasi & Suara?</p>
            <button onclick="requestNotifPermission()" class="bg-white text-blue-700 py-2 rounded-xl font-black text-xs uppercase">AKTIFKAN SEKARANG</button>
        </div>

        <div class="text-center mb-6">
            <img src="logo_kodpen.png" class="mx-auto w-24 mb-2" onerror="this.src='https://via.placeholder.com/100?text=KODPEN'">
            <h2 class="text-xl font-black text-starbucks italic uppercase tracking-tighter">"So Ba Kopi Bro?"</h2>
        </div>

        <div class="mb-4 rounded-xl shadow-lg border-4 border-starbucks overflow-hidden bg-white"><img src="ThisOurMenu.jpg" class="w-full"></div>

        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <div class="flex justify-between items-center mb-4">
                <label class="font-bold text-sm">Nomor Meja:</label>
                <button id="muteBtn" onclick="toggleMute()" class="text-starbucks bg-gray-100 p-2 rounded-full ring-2 ring-starbucks">
                    <i id="muteIcon" class="fas fa-volume-up fa-lg"></i>
                </button>
            </div>
            <select id="nomorMeja" class="w-full p-3 border rounded-lg outline-none"><option value="">-- Pilih Meja --</option></select>
        </div>

        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <label class="block font-bold mb-2 border-b pb-2 uppercase text-xs text-gray-400">Daftar Menu:</label>
            <div id="list-iced"></div><div id="list-non"></div><div id="list-manual"></div>
        </div>

        <div id="ringkasanContainer" class="bg-white p-4 rounded-xl shadow mb-6 hidden border-l-8 border-starbucks">
            <label class="block font-bold mb-2 border-b pb-2 uppercase text-[10px] text-starbucks">Detail Pilihan Anda:</label>
            <div id="ringkasanList" class="space-y-1 text-xs font-medium text-gray-700 border-b pb-2 mb-2"></div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <div class="space-y-4 mb-4">
                <label class="flex items-start p-3 border-2 border-blue-100 rounded-lg cursor-pointer bg-blue-50/30">
                    <input type="radio" name="payment" value="Transfer BNI" onchange="valBtn()" class="mt-1 mr-3"> 
                    <div class="flex flex-col">
                        <span class="font-black text-blue-800 text-base leading-tight">BANK BNI (bank negara indonesia)</span>
                        <span class="text-blue-700 font-extrabold text-lg tracking-wider">0388924011</span>
                        <span class="text-blue-900 font-bold text-sm uppercase">A.n FAZRIN HARUN</span>
                    </div>
                </label>

                <label class="flex items-center p-3 border rounded-lg cursor-pointer">
                    <input type="radio" name="payment" value="QRIS" onchange="valBtn()" class="mr-3"> 
                    <span class="font-bold text-gray-700">QRIS (Scan Barcode)</span>
                </label>

                <label class="flex items-center p-3 border rounded-lg cursor-pointer">
                    <input type="radio" name="payment" value="Tunai" onchange="valBtn()" class="mr-3" checked> 
                    <span class="font-bold text-gray-700">Tunai (Bayar di Kasir)</span>
                </label>
            </div>
            
            <div id="uploadArea" class="hidden p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <div id="qrisSection" class="hidden text-center mb-4">
                    <img id="qrisImg" src="Barcode.png" class="w-48 mx-auto rounded shadow border-2 border-starbucks mb-2">
                    <button onclick="downloadQR()" class="text-[10px] bg-gray-200 px-3 py-1 rounded-full font-bold uppercase mb-4">
                        <i class="fas fa-download mr-1"></i> Simpan QR Code
                    </button>
                </div>
                <p class="text-[10px] font-bold text-red-600 mb-2 uppercase text-center">Wajib Upload Bukti!</p>
                <input type="file" id="buktiFile" accept="image/*" onchange="valBtn()" class="text-xs w-full">
            </div>
        </div>

        <div class="text-center py-6 bg-white rounded-xl shadow-2xl px-4 sticky bottom-4 border-t-2 border-gray-100">
            <div id="statusContainer" class="hidden mb-4 space-y-2">
                
                <div id="msgTunai" class="hidden p-3 bg-red-100 border-2 border-red-600 rounded-lg text-red-700 text-xs font-black blink-notif uppercase leading-tight">
                    segera lakukan pembayaran di kasir agar pesanan anda di proses.
                </div>

                <div id="msgProses" class="hidden p-3 bg-green-600 border-2 border-white rounded-lg text-white text-xs font-black blink-notif uppercase shadow-lg">
                    PESANAN ANDA DI PROSES, HARAP DI TUNGGU!!
                </div>

                <div id="msgJemput" class="hidden p-4 bg-blue-600 border-2 border-white rounded-xl text-white shadow-2xl">
                    <p class="text-xs font-black blink-notif uppercase mb-3 leading-snug">
                        PESANAN ANDA SELESAI DI PROSES DAN AKAN SEGERA DI ANTAR ATAU JIKA ANDA BERKENAN MENJEMPUT DI MEJA KASIR!
                    </p>
                    <button id="btnStopJemput" onclick="stopJemputAlarm()" class="w-full bg-white text-blue-600 py-2 rounded-lg font-black text-[10px] uppercase shadow-md">MATIKAN ALARM / SAYA MENJEMPUT</button>
                </div>

                <div id="msgBatal" class="hidden p-3 bg-gray-900 text-white rounded-lg text-[10px] font-bold uppercase">‚ùå PESANAN DIBATALKAN</div>
            </div>

            <div class="text-xl font-bold mb-4 border-t pt-2 text-gray-800">Total: <span id="totalHarga" class="text-starbucks text-2xl font-black">Rp 0</span></div>
            
            <button id="btnPesan" onclick="kirimPesanan()" class="w-full bg-starbucks text-white font-bold py-4 rounded-full shadow-xl active:scale-95 transition uppercase tracking-widest">PESAN SEKARANG</button>
            
            <button id="btnMyBill" onclick="unduhStruk()" class="hidden w-full mt-4 bg-blue-600 text-white font-bold py-4 rounded-full shadow-xl uppercase text-xs">MY BILL (LIHAT NOTA)</button>
        </div>
    </div>

    <div class="receipt-hidden"><div id="receipt-area"></div></div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzmFG5VBjx9_dIfFpKfXKZ1WT-Kxfa3J2yGFqP236uxQ6R8wiwN0mLQenyPZaFLSKfT4A/exec';
        const menuData = { iced:[{n:"Street Coffee", h:15000},{n:"Americano", h:15000},{n:"ButterStreet", h:20000},{n:"Aren Royale", h:20000},{n:"Pop Rock", h:20000}], non:[{n:"Chocolate", h:18000},{n:"Matcha", h:18000},{n:"Red Velvet", h:18000}], manual:[{n:"Hot Coffee Milk", h:13000}] };
        
        let keranjang = {}; let pollStatus; let currentStatus = ""; let jemputInterval; let isMuted = false;
        const soundJemput = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 

        document.addEventListener('DOMContentLoaded', () => {
            const sel = document.getElementById('nomorMeja');
            for(let i=1; i<=20; i++) sel.innerHTML += `<option value="${i}">Meja ${i}</option>`;
            const urlMeja = new URLSearchParams(window.location.search).get('meja');
            if(urlMeja) sel.value = urlMeja;
            if (Notification.permission !== "granted") document.getElementById('notifPermissionBox').classList.remove('hidden');

            Object.keys(menuData).forEach(cat => {
                const cont = document.getElementById('list-' + (cat==='iced'?'iced':cat==='non'?'non':'manual'));
                menuData[cat].forEach(item => {
                    const id = item.n.replace(/\s+/g, '');
                    cont.innerHTML += `<div class="menu-item flex justify-between items-center px-1"><div><p class="font-bold text-sm text-gray-800">${item.n}</p><p class="text-xs text-gray-400 italic">Rp ${item.h.toLocaleString()}</p></div><div class="flex items-center gap-3"><button onclick="qty('${item.n}',${item.h},-1)" class="w-8 h-8 rounded-full bg-gray-100 font-bold">-</button><span id="q-${id}" class="font-bold text-sm w-4 text-center">0</span><button onclick="qty('${item.n}',${item.h},1)" class="w-8 h-8 rounded-full bg-starbucks text-white font-bold">+</button></div></div>`;
                });
            });
            loadFromMemory();
            valBtn();
        });

        // Toggle Mute: Mempengaruhi semua suara termasuk alarm jemput
        function toggleMute() {
            isMuted = !isMuted;
            const icon = document.getElementById('muteIcon');
            if(isMuted) {
                icon.className = 'fas fa-volume-mute fa-lg text-red-500';
                clearInterval(jemputInterval); // Langsung hentikan jika sedang bunyi
            } else {
                icon.className = 'fas fa-volume-up fa-lg text-green-600';
            }
        }

        function requestNotifPermission() { 
            Notification.requestPermission().then(p => { if(p === "granted") document.getElementById('notifPermissionBox').classList.add('hidden'); }); 
        }

        function triggerNotif(t, b, s) { 
            // Cek apakah muted aktif sebelum memutar suara jemput
            if(!isMuted && s === "jemput") {
                let cnt = 0;
                clearInterval(jemputInterval); // Bersihkan interval sebelumnya
                jemputInterval = setInterval(() => {
                    if(!isMuted) {
                        soundJemput.play().catch(()=>{});
                        cnt++; if(cnt >= 15) clearInterval(jemputInterval);
                    } else {
                        clearInterval(jemputInterval);
                    }
                }, 1500);
            }
            if (Notification.permission === "granted") new Notification(t, { body: b, icon: "logo_kodpen.png" }); 
        }

        function stopJemputAlarm() {
            clearInterval(jemputInterval);
            document.getElementById('msgJemput').classList.remove('shadow-2xl');
            document.getElementById('btnStopJemput').innerText = "MENUNGGU BARISTA...";
        }

        function downloadQR() {
            const link = document.createElement('a');
            link.href = document.getElementById('qrisImg').src;
            link.download = 'QRIS_KODPEN_COFFEE.png';
            link.click();
        }

        function qty(n,h,c) { if(!keranjang[n]) keranjang[n]={q:0,h:h}; keranjang[n].q+=c; if(keranjang[n].q<0) keranjang[n].q=0; document.getElementById('q-'+n.replace(/\s+/g,'')).innerText=keranjang[n].q; updateRingkasan(); localStorage.setItem('kodpen_keranjang', JSON.stringify(keranjang)); }
        
        function updateRingkasan() {
            const cont = document.getElementById('ringkasanContainer'); const list = document.getElementById('ringkasanList'); let t = 0; list.innerHTML = "";
            Object.keys(keranjang).forEach(k => { if(keranjang[k].q > 0) { t += (keranjang[k].q * keranjang[k].h); list.innerHTML += `<div class="flex justify-between border-b border-gray-100 py-1"><span>${k} (x${keranjang[k].q})</span><span>Rp ${(keranjang[k].q * keranjang[k].h).toLocaleString()}</span></div>`; } });
            cont.classList.toggle('hidden', t === 0); document.getElementById('totalHarga').innerText = "Rp " + t.toLocaleString('id-ID'); valBtn();
        }

        function loadFromMemory() {
            const savedK = localStorage.getItem('kodpen_keranjang'); const savedID = localStorage.getItem('kodpen_id'); const savedData = localStorage.getItem('kodpen_data');
            if(savedK) { keranjang = JSON.parse(savedK); updateRingkasan(); Object.keys(keranjang).forEach(k => { const el = document.getElementById('q-'+k.replace(/\s+/g,'')); if(el) el.innerText = keranjang[k].q; }); }
            if(savedID && savedData) {
                lastOrder = JSON.parse(savedData);
                fetch(`${scriptURL}?orderId=${savedID}`).then(r => r.text()).then(status => {
                    if (status !== "Selesai" && status !== "NotFound") { 
                        document.getElementById('btnPesan').classList.add('hidden'); 
                        document.getElementById('btnMyBill').classList.remove('hidden'); 
                        startPolling(savedID, lastOrder.pembayaran, status); 
                    } else { localStorage.clear(); }
                });
            }
        }

        function valBtn() { 
            const pay = document.querySelector('input[name="payment"]:checked').value; 
            const btn = document.getElementById('btnPesan');
            const fileInput = document.getElementById('buktiFile');
            document.getElementById('qrisSection').classList.toggle('hidden', pay !== 'QRIS');
            if(pay === 'Tunai'){ 
                document.getElementById('uploadArea').classList.add('hidden'); btn.disabled = false; 
            } else { 
                document.getElementById('uploadArea').classList.remove('hidden'); 
                btn.disabled = (fileInput.files.length === 0); 
            } 
        }

        async function kirimPesanan() {
            const meja = document.getElementById('nomorMeja').value; if(!meja) return alert("Pilih Meja!");
            const fileInput = document.getElementById('buktiFile'); let det = ""; Object.keys(keranjang).forEach(k => { if(keranjang[k].q > 0) det += `${k} (x${keranjang[k].q}), `; });
            if(!det) return alert("Pilih Menu!");
            const btn = document.getElementById('btnPesan'); btn.innerText = "MENGIRIM..."; btn.disabled = true;
            const orderId = "ORD-" + new Date().getTime();
            let fileB64 = ""; if(fileInput.files.length > 0) { fileB64 = await new Promise(r => { const reader = new FileReader(); reader.onload = () => r(reader.result); reader.readAsDataURL(fileInput.files[0]); }); }
            lastOrder = { orderId, meja, pesanan: det.slice(0,-2), pembayaran: document.querySelector('input[name="payment"]:checked').value, total: document.getElementById('totalHarga').innerText, date: new Date().toLocaleString() };
            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({...lastOrder, fileBase64: fileB64, fileName: fileInput.files[0]?.name || ""}) })
            .then(() => { localStorage.setItem('kodpen_id', orderId); localStorage.setItem('kodpen_data', JSON.stringify(lastOrder)); alert("PESANAN TERKIRIM!"); btn.classList.add('hidden'); document.getElementById('btnMyBill').classList.remove('hidden'); startPolling(orderId, lastOrder.pembayaran, "Antri"); });
        }

        function startPolling(id, pay, initialStatus) {
            currentStatus = initialStatus; document.getElementById('statusContainer').classList.remove('hidden'); updateUI(initialStatus, pay);
            pollStatus = setInterval(() => {
                fetch(`${scriptURL}?orderId=${id}`).then(res => res.text()).then(status => {
                    if (status !== currentStatus) {
                        if (status === "Proses") triggerNotif("KODPEN COFFEE", "Pesanan Sedang Diproses! ‚òï", "proses");
                        else if (status === "Jemput") triggerNotif("KODPEN COFFEE", "SIAP DIJEMPUT! üîî", "jemput");
                        else if (status === "Selesai") { clearInterval(jemputInterval); localStorage.clear(); window.location.reload(); }
                        updateUI(status, pay); currentStatus = status;
                    }
                });
            }, 4000);
        }

        function updateUI(s, pay) {
            const mT = document.getElementById('msgTunai'); const mP = document.getElementById('msgProses'); const mJ = document.getElementById('msgJemput'); const mB = document.getElementById('msgBatal');
            mT.classList.add('hidden'); mP.classList.add('hidden'); mJ.classList.add('hidden'); mB.classList.add('hidden');
            
            // Logika Sesuai Permintaan:
            // 1. Antri & Tunai -> Merah Berkedip
            if(s === "Antri" && pay === "Tunai") mT.classList.remove('hidden');
            
            // 2. Proses -> Hijau Berkedip (Berlaku semua metode bayar)
            if(s === "Proses") mP.classList.remove('hidden');
            
            // 3. Jemput -> Biru Berkedip (Berlaku semua metode bayar)
            if(s === "Jemput") mJ.classList.remove('hidden');
            
            if(s === "Batal") mB.classList.remove('hidden');
        }

        function unduhStruk() {
            const area = document.getElementById('receipt-area');
            area.innerHTML = `<div style="text-align:center"><img src="logo_kodpen.png" style="width:20mm;margin:0 auto"><br><strong>KODPEN COFFEE</strong><br>MEJA ${lastOrder.meja}<br><hr>${lastOrder.pesanan.split(', ').join('<br>')}<br><hr>Total: ${lastOrder.total}<br>Pay: ${lastOrder.pembayaran}</div>`;
            html2canvas(area, {scale:3}).then(c => { const a = document.createElement('a'); a.download = `NOTA_KODPEN_${lastOrder.meja}.png`; a.href = c.toDataURL(); a.click(); });
        }
    </script>
</body>
</html>
